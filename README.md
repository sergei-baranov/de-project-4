# Проект 4

## Настройки соединений в Airflow

1. Postgres в DWH - connection `PG_WAREHOUSE_CONNECTION`
   - создаём руками в соответствии с настройками из уроков спринта
2. Параметры для доступа к источникам по api `http_conn_id` (http):
   - Host: `https://d5d04q7d963eapoepsqr.apigw.yandexcloud.net`
   - X-Api_Key и т.п. жёстко пишем в питоновском коде DAG-а

## Структура таблиц в DWH

Создаётся, при отсутствии, в таске init_task DAG-а project4.py.
Отрабатываются инструкции из `src/DAG/sql/init.sql`.

При необходимости пересоздать с ноля (с удалением) - исполняем руками стейтменты из `src/DAG/sql/recover.sql`.

**DDL на все три слоя (CDM, DDS, STG) см. в init.sql/recover.sql.**

При необходимости только потранкейтить и сбросить сериалы - чистим руками записи в таблице с настройками джоб (stg.srv_wf_settings), сами таблицы исследуем через
```sql
-- меняем значение table_schema и table_name на необходимые,
-- ищем в ответе названия SEQUENCE для альтера
SELECT column_default from
information_schema.columns
where
table_schema = 'stg'
AND table_name='srv_wf_settings'
AND column_default IS NOT NULL
;
```
, далее сбрасываем автоинкремент поля через
```sql
-- меняем название SEQUENCE на найденное
ALTER SEQUENCE stg.srv_wf_settings_id_seq RESTART WITH 1;
```

## DAG

Одна таска на инициализацию, и три в параллель на STG-слой.

Инициализация:
- исполняетс запрос из `dags/init.sql`.

**NB:** В коде жёстко прописан путь
```python
sql_path = '/lessons/dags/sql'
```

STG заливаем as is.

- Сортировка в запросе к источнику по id,
- последний успешно отработанный сохраняем в настройки (нет, см. ниже).

**NB:** API /restaurants и /couriers не даёт фильтровать по id (и ни по чём не дают). Поэтому "последний успешно отработанный сохраняем в настройки" - не делаем; листаем и апсертим до упора.

Можно было бы сохранять оффсет при сортировке по id, но нигде не сказано, что между запусками id не добавляются в череду уже пройденных оффсетом.

К тому же id тут не число, а наверное что-то вроде монговского ObjectId (_id в ответе api-операции - прям строка, похожая на хеш).

**По факту:** sort_field в api не особо и работает. Что передвать? `id`, `_id`, `_idd`? Результат идентичен.

**NB2:** API /deliveries понимает `from` и `to` фильтры. Поэтому вроде бы можно в настройках сохранять `to` последнего успешного запроса. Только непонятно, как тогда работать - во `from` передавать `to` предыдущей отработки из настроек, а в `to` что передавать? Какой там люфт на внесение заказов в апи? Может сутки... может год...
Кстати, туда попадают только выполненные и оценённые доставки?

**В итоге:** весь стейджинг-слой собираем каждый раз из API полностью, и апсертим.

Фильтры и сортировку вообще не указываем, только листаем оффсет (исходим из того, что система под капотом api сама отсортирует данные по какому-то внутреннему id).

**Допущение:** Доставки (...apigw.yandexcloud.net/deliveries) не принимают фильтр по restaurant_id (возвращают пустой массив), поэтому все доставки считаем от Кофейни (хотя для STG as is это пока и не важно).